<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—¥ã€…ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0 20px;
      background: #f9f9f9;
      color: #333;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 0;
      border-bottom: 1px solid #ccc;
      flex-wrap: wrap;
    }
    .title-area h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    .title-area p {
      margin: 4px 0 0 0;
      font-size: 1rem;
      color: #007bff;
      cursor: pointer;
      text-decoration: underline;
      user-select: none;
    }
    main {
      max-width: 600px;
      margin: 20px auto;
    }
    section {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      font-size: 1.3rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
      color: #444;
    }
    h3 {
      margin: 0 0 0.5em 0;
      font-size: 1.1rem;
      color: #555;
    }
    form {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    form input[type="time"],
    form input[type="text"] {
      flex: 1 1 120px;
      padding: 8px 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    form button {
      padding: 8px 16px;
      font-size: 1rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      flex: 0 0 auto;
    }
    form button:hover {
      background-color: #0056b3;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin-bottom: 6px;
    }
    footer {
      text-align: center;
      padding: 10px 0;
      font-size: 0.9rem;
      color: #999;
      border-top: 1px solid #ddd;
      margin-top: 40px;
    }
    #date-picker {
      display: none;
    }
    /* åˆ é™¤æŒ‰é’®æ ·å¼ */
    .delete-btn {
      margin-left: 10px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 2px 8px;
      cursor: pointer;
    }
    .delete-btn:hover {
      background: #c0392b;
    }
    #logout-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 1rem;
    }
    #logout-btn:hover {
      background-color: #a71d2a;
    }
  </style>
</head>
<body>
  <header>
    <div class="title-area">
      <h1>ğŸ“… æ—¥ã€…ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</h1>
      <p id="today-date" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ—¥ä»˜ã‚’å¤‰æ›´"></p>
      <input type="date" id="date-picker" />
    </div>
    <button id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </header>

  <section class="weather-info" style="background:#fff; padding:15px; border-radius:8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); max-width:600px; margin:0 auto 20px;">
    <h2>ç¾åœ¨ã®å¤©æ°—</h2>
    <div id="weather-city">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="weather-text"></div>
  </section>


  <main>
    <section class="reminder-list">
      <h2>æœ¬æ—¥ã®äºˆå®š</h2>
      <ul id="reminders">èª­ã¿è¾¼ã¿ä¸­...</ul>
    </section>

    <form id="reminder-form">
      <input type="time" id="reminder-time" required />
      <input type="text" id="reminder-title" placeholder="å†…å®¹ï¼ˆä¾‹ï¼šè²·ã„ç‰©ï¼‰" required />
      <button type="submit">è¿½åŠ </button>
    </form>

    <section class="reminder-list">
      <h2>äºˆå®šä¸€è¦§ï¼ˆ7æ—¥é–“ï¼‰</h2>
      <div id="reminder-calendar"></div>
    </section>
  </main>

  <footer>
    <p>Â© 2025 æ—¥ã€…ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB1rn_gHtXv6p38yirYCZuEX8HXqxFmCKQ",
      authDomain: "reminder-app-73c7d.firebaseapp.com",
      projectId: "reminder-app-73c7d",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = null;
    let remindersData = {};
    let selectedDate = new Date();
    selectedDate.setHours(0, 0, 0, 0);

    // ç™»å½•çŠ¶æ€
    firebase.auth().onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        loadRemindersFromFirestore(user.uid);
      }
    });

    function loadRemindersFromFirestore(uid) {
      db.collection("users").doc(uid).get().then(doc => {
        if (doc.exists && doc.data()?.reminders) {
          remindersData = doc.data().reminders;
        } else {
          remindersData = {};
        }
        updateSelectedDate(selectedDate);
      });
    }

    function saveRemindersToFirestore(uid) {
      db.collection("users").doc(uid).set({ reminders: remindersData }, { merge: true });
    }

    const todayDateElem = document.getElementById("today-date");
    const datePicker = document.getElementById("date-picker");
    const remindersUl = document.getElementById("reminders");
    const reminderForm = document.getElementById("reminder-form");
    const reminderTimeInput = document.getElementById("reminder-time");
    const reminderTitleInput = document.getElementById("reminder-title");
    const reminderCalendar = document.getElementById("reminder-calendar");
    const logoutBtn = document.getElementById("logout-btn");

    function formatDate(date) {
      return date.toISOString().slice(0, 10);
    }

    function formatDisplayDate(date) {
      const days = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
      return `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥ï¼ˆ${days[date.getDay()]}ï¼‰`;
    }

    function updateSelectedDate(date) {
      selectedDate = date;
      todayDateElem.textContent = formatDisplayDate(date);
      datePicker.value = formatDate(date);
      renderRemindersForSelectedDate();
      renderReminderCalendar();
      updateWeatherForDate(date); 
    }

    todayDateElem.addEventListener("click", () => {
      if (datePicker.showPicker) {
        datePicker.showPicker();
      } else {
        datePicker.style.display = "inline-block";
        datePicker.focus();
      }
    });

    datePicker.addEventListener("change", (e) => {
      const picked = new Date(e.target.value);
      if (!isNaN(picked)) {
        picked.setHours(0,0,0,0);
        updateSelectedDate(picked);
      }
      if (!datePicker.showPicker) {
        datePicker.style.display = "none";
      }
    });

    function renderRemindersForSelectedDate() {
      const key = formatDate(selectedDate);
      const items = remindersData[key] || [];
      remindersUl.innerHTML = "";
      if (items.length === 0) {
        remindersUl.textContent = "äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }
      items.forEach((r, index) => {
        const li = document.createElement("li");
        li.style.display = "flex";
        li.style.justifyContent = "space-between";
        li.style.alignItems = "center";

        const textSpan = document.createElement("span");
        textSpan.textContent = `${r.time} - ${r.title}`;
        li.appendChild(textSpan);

        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.className = "delete-btn";
        delBtn.addEventListener("click", () => {
          remindersData[key].splice(index, 1);
          renderRemindersForSelectedDate();
          renderReminderCalendar();
          saveRemindersToFirestore(currentUser.uid);
        });
        li.appendChild(delBtn);
        remindersUl.appendChild(li);
      });
    }

    reminderForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const time = reminderTimeInput.value;
      const title = reminderTitleInput.value.trim();

      if (!time || !title) {
        alert("æ™‚é–“ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const key = formatDate(selectedDate);
      if (!remindersData[key]) {
        remindersData[key] = [];
      }
      remindersData[key].push({ time, title });
      reminderForm.reset();
      renderRemindersForSelectedDate();
      renderReminderCalendar();
      saveRemindersToFirestore(currentUser.uid);
    });

    function renderReminderCalendar() {
      reminderCalendar.innerHTML = "";
      const today = new Date();
      today.setHours(0,0,0,0);
      today.setDate(today.getDate() + 1);

      for (let i = 0; i < 7; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        const key = formatDate(d);
        const items = remindersData[key] || [];

        const section = document.createElement("section");
        section.style.marginBottom = "1em";

        const h3 = document.createElement("h3");
        h3.textContent = formatDisplayDate(d);
        section.appendChild(h3);

        if (items.length === 0) {
          const p = document.createElement("p");
          p.textContent = "äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
          section.appendChild(p);
        } else {
          const ul = document.createElement("ul");
          for (const r of items) {
            const li = document.createElement("li");
            li.textContent = `${r.time} - ${r.title}`;
            ul.appendChild(li);
          }
          section.appendChild(ul);
        }
        reminderCalendar.appendChild(section);
      }
    }

    logoutBtn.addEventListener("click", () => {
      firebase.auth().signOut().then(() => {
        window.location.href = "login.html";
      }).catch((error) => {
        alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + error.message);
      });
    });

    let weatherForecasts = {}; // ä¿å­˜å¤šæ—¥å¤©æ°”æ•°æ®ï¼Œkeyæ˜¯"YYYY-MM-DD"

// æ”¹æˆè·å–5å¤©/3å°æ—¶é¢„æŠ¥
    async function loadWeather() {
      const apiKey = "97349a7b4d97217b289ed4961f48c829";
      const cityElem = document.getElementById("weather-city");
      const weatherTextElem = document.getElementById("weather-text");

      if (!navigator.geolocation) {
        cityElem.textContent = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚";
        weatherTextElem.textContent = "";
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          await fetchWeatherForecast(lat, lon);
          updateWeatherForDate(selectedDate);  // åˆæ¬¡æ˜¾ç¤ºé€‰ä¸­æ—¥æœŸå¤©æ°”
        },
        async (err) => {
          console.warn("ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼ã€‚Tokyoã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯", err);
          // ä¸œäº¬ç»çº¬åº¦å›ºå®š
          await fetchWeatherForecast(35.68, 139.76);
          updateWeatherForDate(selectedDate);
        }
      );

      async function fetchWeatherForecast(lat, lon) {
        const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${apiKey}&lang=ja&units=metric`;
        try {
          const res = await fetch(url);
          const data = await res.json();

          cityElem.textContent = `ç¾åœ¨ã®éƒ½å¸‚: ${data.city.name}`;

          // æ¸…ç©ºæ—§æ•°æ®
          weatherForecasts = {};

          // data.list æ˜¯3å°æ—¶é¢„æŠ¥æ•°ç»„
          // æŠŠ3å°æ—¶é¢„æŠ¥æŒ‰æ—¥æœŸå½’ç»„
          data.list.forEach(item => {
            const date = item.dt_txt.slice(0, 10); // yyyy-mm-dd
            if (!weatherForecasts[date]) weatherForecasts[date] = [];
            weatherForecasts[date].push(item);
          });
        } catch (e) {
          cityElem.textContent = "";
          weatherTextElem.textContent = "âš ï¸ å¤©æ°—æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
          console.error(e);
        }
      }
    }

    // æ ¹æ®æ—¥æœŸï¼Œæ›´æ–°å¤©æ°”æ˜¾ç¤º
    function updateWeatherForDate(date) {
      const weatherTextElem = document.getElementById("weather-text");
      const key = date.toISOString().slice(0, 10); // yyyy-mm-dd

      if (!weatherForecasts[key]) {
        weatherTextElem.textContent = "ãã®æ—¥ã®å¤©æ°—äºˆå ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        return;
      }

      // ç®€å•å–å½“å¤©ç¬¬ä¸€ä¸ªæ—¶æ®µæ•°æ®ä»£è¡¨å…¨å¤©ï¼ˆå¯ä»¥æ”¹æ›´å¤æ‚ç®—æ³•ï¼‰
      const weatherData = weatherForecasts[key][0];

      const weather = weatherData.weather[0].main;
      const description = weatherData.weather[0].description;
      const temp = weatherData.main.temp;

      let advice = "";
      if (weather === "Rain" || weather === "Drizzle" || weather === "Thunderstorm") {
        advice = "ğŸŒ§ é›¨ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚å‚˜ã‚’å¿˜ã‚Œãšã«ï¼";
      } else if (weather === "Clear") {
        advice = "â˜€ï¸ æ™´ã‚Œã®äºˆå ±ã§ã™ã€‚ç´«å¤–ç·šå¯¾ç­–ã‚’å¿˜ã‚Œãšã«ï¼";
      } else if (weather === "Clouds") {
        advice = "â˜ï¸ æ›‡ã‚Šã®äºˆå ±ã§ã™ã€‚éã”ã—ã‚„ã™ã„å¤©æ°—ã§ã™ã€‚";
      } else if (weather === "Snow") {
        advice = "â„ï¸ é›ªã®äºˆå ±ã§ã™ã€‚æš–ã‹ãã—ã¦ãã ã•ã„ã€‚";
      } else {
        advice = `ğŸŒ¡ å¤©æ°—ï¼š${description}`;
      }

      weatherTextElem.textContent = `${advice}ï¼ˆäºˆæƒ³æ°—æ¸© ${temp.toFixed(1)}â„ƒï¼‰`;
    }

  
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å¤©æ°—æƒ…å ±å–å¾—
    window.addEventListener("load", () => {
      loadWeather();
    });

  </script>
</body>
</html>
